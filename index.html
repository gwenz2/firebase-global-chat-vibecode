<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple Group Chat</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    #chatCard {
      width: 100%;
      max-width: 480px;
      height: 90vh;
      min-height: 500px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* Login Screen */
    #loginScreen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      padding: 40px 30px;
      text-align: center;
    }

    #loginScreen h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
      font-weight: 600;
    }

    #loginScreen p {
      color: #666;
      margin-bottom: 40px;
      font-size: 16px;
    }

    #loginBtn {
      background: #4285F4;
      color: white;
      border: none;
      border-radius: 50px;
      padding: 16px 32px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    #loginBtn:hover {
      background: #3367d6;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
    }

    /* Chat Header */
    #chatHeader {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    #chatTitle {
      font-size: 18px;
      font-weight: 600;
    }

    #userInfo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }

    #userAvatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.3);
    }

    /* Messages Area */
    #messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #f8f9fa;
      scroll-behavior: smooth;
    }

    /* Custom scrollbar */
    #messages::-webkit-scrollbar {
      width: 6px;
    }

    #messages::-webkit-scrollbar-track {
      background: transparent;
    }

    #messages::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 3px;
    }

    #messages::-webkit-scrollbar-thumb:hover {
      background: #999;
    }

    .message {
      margin: 12px 0;
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 80%;
      word-wrap: break-word;
      position: relative;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.me {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .message.other {
      background: white;
      color: #333;
      margin-right: auto;
      border-bottom-left-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .message-sender {
      font-size: 12px;
      opacity: 0.8;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .message-text {
      font-size: 14px;
      line-height: 1.4;
    }

    .message-time {
      font-size: 11px;
      opacity: 0.6;
      margin-top: 4px;
      text-align: right;
    }

    /* Input Area */
    #inputArea {
      display: flex;
      padding: 20px;
      background: white;
      border-top: 1px solid #eee;
      gap: 12px;
      align-items: flex-end;
    }

    #messageInput {
      flex: 1;
      border: 2px solid #e0e0e0;
      border-radius: 25px;
      padding: 12px 18px;
      outline: none;
      font-size: 14px;
      resize: none;
      min-height: 20px;
      max-height: 100px;
      transition: border-color 0.3s ease;
      font-family: inherit;
    }

    #messageInput:focus {
      border-color: #667eea;
    }

    #sendBtn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    #sendBtn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    #sendBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    #logoutBtn {
      background: transparent;
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    #logoutBtn:hover {
      background: rgba(255,255,255,0.1);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      color: #999;
      padding: 40px 20px;
      font-style: italic;
    }

    /* Loading indicator */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      #chatCard {
        height: 95vh;
        max-width: 100%;
        border-radius: 12px;
      }

      #chatHeader {
        padding: 16px 20px;
      }

      #chatTitle {
        font-size: 16px;
      }

      #userInfo {
        font-size: 12px;
      }

      #userAvatar {
        width: 28px;
        height: 28px;
      }

      #messages {
        padding: 15px;
      }

      .message {
        max-width: 85%;
        padding: 10px 14px;
      }

      #inputArea {
        padding: 15px;
        gap: 10px;
      }

      #messageInput {
        padding: 10px 16px;
        font-size: 16px; /* Prevents zoom on iOS */
      }

      #sendBtn {
        width: 40px;
        height: 40px;
      }

      #loginScreen {
        padding: 30px 20px;
      }

      #loginScreen h1 {
        font-size: 24px;
      }
    }

    @media (max-width: 480px) {
      #chatCard {
        border-radius: 8px;
      }

      .message {
        max-width: 90%;
      }

      #inputArea {
        padding: 12px;
      }
    }

    /* Landscape mobile */
    @media (max-height: 500px) and (orientation: landscape) {
      #chatCard {
        height: 95vh;
      }

      #chatHeader {
        padding: 12px 20px;
      }

      #messages {
        padding: 12px;
      }

      #inputArea {
        padding: 12px;
      }
    }

    /* High DPI displays */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
      #chatCard {
        box-shadow: 0 20px 60px rgba(0,0,0,0.2);
      }
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      body {
        background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
      }

      #chatCard {
        background: #1a202c;
        color: #e2e8f0;
      }

      #messages {
        background: #2d3748;
      }

      .message.other {
        background: #4a5568;
        color: #e2e8f0;
      }

      #inputArea {
        background: #1a202c;
        border-top-color: #4a5568;
      }

      #messageInput {
        background: #2d3748;
        color: #e2e8f0;
        border-color: #4a5568;
      }

      #messageInput:focus {
        border-color: #667eea;
      }

      .empty-state {
        color: #a0aec0;
      }
    }

    /* Focus styles for accessibility */
    button:focus,
    input:focus {
      outline: 2px solid #667eea;
      outline-offset: 2px;
    }

    /* Typing indicator */
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 12px;
      margin: 8px 0;
      font-size: 12px;
      color: #667eea;
      font-style: italic;
    }

    .typing-dots {
      display: flex;
      gap: 4px;
    }

    .typing-dots span {
      width: 4px;
      height: 4px;
      background: #667eea;
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div id="chatCard">
    <!-- Login Screen -->
    <div id="loginScreen">
      <h1>💬 Simple Chat</h1>
      <p>Connect with friends in real-time</p>
      <button id="loginBtn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        Continue with Google
      </button>
    </div>

    <!-- Chat Interface -->
    <div id="chatUI" style="display:none; flex:1; flex-direction:column;">
      <!-- Header -->
      <div id="chatHeader">
        <div id="chatTitle">Group Chat</div>
        <div id="userInfo">
          <img id="userAvatar" src="" alt="User Avatar">
          <span id="userName"></span>
          <button id="logoutBtn">Logout</button>
        </div>
      </div>

      <!-- Messages -->
      <div id="messages">
        <div class="empty-state">
          <div>👋</div>
          <div>Start a conversation!</div>
        </div>
      </div>

      <!-- Input Area -->
      <div id="inputArea">
        <textarea id="messageInput" placeholder="Type a message..." rows="1"></textarea>
        <button id="sendBtn" disabled>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    // ✅ Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDgDw-8py40dvUpyvEJBkGufZXytxFvoDg",
      authDomain: "simplegc-1fc48.firebaseapp.com",
      projectId: "simplegc-1fc48",
      storageBucket: "simplegc-1fc48.firebasestorage.app",
      messagingSenderId: "431674118694",
      appId: "1:431674118694:web:6ea21cfc0c91cbed82cce7",
      measurementId: "G-70P7G9NERH"
    };

    // ✅ Init Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const loginScreen = document.getElementById('loginScreen');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const chatUI = document.getElementById('chatUI');
    const messagesDiv = document.getElementById('messages');
    const sendBtn = document.getElementById('sendBtn');
    const messageInput = document.getElementById('messageInput');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');

    let currentUser = null;
    let messagesListener = null;

    // ✅ Auto-resize textarea
    messageInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 100) + 'px';
      
      // Enable/disable send button
      sendBtn.disabled = !this.value.trim();
    });

    // ✅ Send on Enter (but Shift+Enter for new line)
    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (messageInput.value.trim()) {
          sendMessage();
        }
      }
    });

    // ✅ Google login
    loginBtn.onclick = async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        loginBtn.innerHTML = '<div class="spinner"></div> Signing in...';
        loginBtn.disabled = true;
        await auth.signInWithPopup(provider);
      } catch (err) {
        console.error('Login error:', err);
        alert('Login failed. Please try again.');
        loginBtn.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Continue with Google
        `;
        loginBtn.disabled = false;
      }
    };

    // ✅ Logout
    logoutBtn.onclick = async () => {
      try {
        if (messagesListener) {
          messagesListener();
          messagesListener = null;
        }
        await auth.signOut();
        // Force page reload to clear all state
        window.location.reload();
      } catch (err) {
        console.error('Logout error:', err);
        // Still reload even if logout fails to reset the UI
        window.location.reload();
      }
    };

    // ✅ Auth state change
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        loginScreen.style.display = "none";
        chatUI.style.display = "flex";
        
        // Update user info
        userAvatar.src = user.photoURL || 'https://via.placeholder.com/32';
        userName.textContent = user.displayName || 'User';
        
        loadMessages();
      } else {
        currentUser = null;
        loginScreen.style.display = "flex";
        chatUI.style.display = "none";
        messagesDiv.innerHTML = '<div class="empty-state"><div>👋</div><div>Start a conversation!</div></div>';
        
        if (messagesListener) {
          messagesListener();
          messagesListener = null;
        }
      }
    });

    // ✅ Send message
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (text && currentUser) {
        try {
          sendBtn.disabled = true;
          await db.collection("messages").add({
            text,
            uid: currentUser.uid,
            name: currentUser.displayName || 'Anonymous',
            photoURL: currentUser.photoURL || '',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          messageInput.value = "";
          messageInput.style.height = 'auto';
          sendBtn.disabled = true;
        } catch (err) {
          console.error('Send error:', err);
          alert('Failed to send message. Please try again.');
        } finally {
          sendBtn.disabled = !messageInput.value.trim();
        }
      }
    }

    sendBtn.onclick = sendMessage;

    // ✅ Load messages with better UX
    function loadMessages() {
      messagesDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      
      messagesListener = db.collection("messages")
        .orderBy("timestamp")
        .onSnapshot(snapshot => {
          messagesDiv.innerHTML = "";
          
          if (snapshot.empty) {
            messagesDiv.innerHTML = '<div class="empty-state"><div>👋</div><div>Start a conversation!</div></div>';
            return;
          }

          const fragment = document.createDocumentFragment();
          
          snapshot.forEach(doc => {
            const msg = doc.data();
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message");
            messageDiv.classList.add(msg.uid === currentUser.uid ? "me" : "other");
            
            const isMe = msg.uid === currentUser.uid;
            const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
            
            messageDiv.innerHTML = `
              ${!isMe ? `<div class="message-sender">${msg.name}</div>` : ''}
              <div class="message-text">${escapeHtml(msg.text)}</div>
              ${time ? `<div class="message-time">${time}</div>` : ''}
            `;
            
            fragment.appendChild(messageDiv);
          });
          
          messagesDiv.appendChild(fragment);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }, err => {
          console.error('Messages error:', err);
          messagesDiv.innerHTML = '<div class="empty-state"><div>❌</div><div>Failed to load messages</div></div>';
        });
    }

    // ✅ Utility function to escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ✅ Format timestamp
    function formatTime(timestamp) {
      if (!timestamp) return '';
      return new Date(timestamp.toDate()).toLocaleTimeString([], {
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // ✅ Handle network status
    window.addEventListener('online', () => {
      console.log('Back online');
    });

    window.addEventListener('offline', () => {
      console.log('Gone offline');
    });

    // ✅ Prevent zoom on iOS input focus
    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
      const viewport = document.querySelector('meta[name=viewport]');
      viewport.setAttribute('content', viewport.content + ', user-scalable=no');
    }
  </script>
</body>
</html>